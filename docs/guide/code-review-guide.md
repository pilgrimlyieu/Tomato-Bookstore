# 代码审查指南

本文档详细说明了番茄商城项目的代码审查流程和规范。代码审查是保证代码质量、知识分享和团队成长的重要环节。

## 代码审查目标

1. **提高代码质量**：识别潜在问题和缺陷，确保代码符合项目标准
2. **知识共享**：促进团队成员间的技术交流和知识传递
3. **保持一致性**：确保代码风格和架构的一致性
4. **培养团队成员**：帮助所有成员提升技术能力

## 审查流程

### 1. 提交 Pull Request

1. 开发者完成功能开发并进行自测
2. 创建 Pull Request（PR）
3. 在 PR 描述中简要说明：
   - 实现的功能或修复的问题
   - 解决方案概述
   - 可能的影响范围
   - 需要审查者特别关注的部分

### 2. 指派审查者

1. 根据代码变更的内容，选择合适的审查者
2. 前端代码优先指派前端开发者审查
3. 后端代码优先指派后端开发者审查
4. 核心功能或复杂变更可以指派多名审查者

### 3. 审查过程

1. 审查者在收到审查请求后的 48 小时内完成审查
2. 使用 GitHub Pull Request Review 功能进行审查
3. 提交代码评论时遵循[反馈原则](#反馈原则)
4. 可以使用以下评审选项：
   - **Comment**：提供一般性反馈，不阻碍合并
   - **Approve**：代码审查通过，可以合并
   - **Request Changes**：需要进行修改后再次审查

### 4. 修复与重新审查

1. 开发者根据审查反馈修改代码
2. 提交新的变更并回复评论
3. 审查者重新审查修改的部分
4. 如没有进一步问题，审查者批准合并

### 5. 合并与部署

1. 通过审查后，可以将 PR 合并到主分支
2. 合并应优先使用 "Squash and merge" 模式，将所有修改压缩为一个提交
3. PR 合并后，相关分支可以删除

## 审查重点

### 通用重点

1. **功能完整性**：是否完全实现了需求
2. **代码可读性**：命名是否清晰，代码结构是否易于理解
3. **代码复用**：是否有冗余代码可以抽象为公共方法
4. **性能考虑**：是否存在性能问题（如大循环、重复计算）
5. **安全性**：是否存在安全隐患（XSS, SQL 注入等）
6. **错误处理**：是否妥善处理异常情况
7. **兼容性**：是否考虑各种使用场景和边界条件

### 前端审查重点

1. **用户体验**：UI 是否符合设计，交互是否流畅
2. **响应式设计**：是否适应不同屏幕尺寸
3. **状态管理**：Pinia store 的设计和使用是否合理
4. **组件化**：组件划分是否合理，是否可复用
5. **类型安全**：TypeScript 类型定义是否准确完整
6. **接口调用**：是否正确处理异步请求和加载状态
7. **样式结构**：CSS 组织是否合理，是否遵循项目规范

### 后端审查重点

1. **API 设计**：API 是否符合 RESTful 设计原则
2. **数据库操作**：是否有效率低下的查询或操作
3. **事务处理**：是否正确使用事务来保证数据一致性
4. **安全控制**：权限验证是否完善
5. **日志记录**：是否在关键位置添加了适当的日志
6. **单元测试**：关键方法是否有测试覆盖

## 审查清单

使用以下清单确保审查覆盖所有关键点：

### 功能清单

- [ ] 实现了所有需求功能
- [ ] 处理了边界情况
- [ ] 包含错误处理
- [ ] 考虑了性能影响

### 代码质量清单

- [ ] 遵循代码风格规范
- [ ] 命名清晰且一致
- [ ] 代码组织结构合理
- [ ] 注释充分且有意义
- [ ] 没有不必要的复杂性
- [ ] 没有重复代码

### 安全清单

- [ ] 输入数据已验证
- [ ] 敏感数据已保护
- [ ] 权限检查已实施
- [ ] 没有硬编码的凭证
- [ ] 正确处理用户生成的内容

### 测试清单

- [ ] 单元测试通过且覆盖率足够
- [ ] 边界条件已测试
- [ ] 集成测试确保组件正常工作
- [ ] 手动测试了主要功能

## 反馈原则

在提供代码审查反馈时，请遵循以下原则：

1. **具体而非泛泛**：
   - ❌ 「这段代码不好」
   - ✅ 「这个循环可以使用数组的 map 方法重构，提高可读性」

2. **解释原因**：
   - ❌ 「应该用常量」
   - ✅ 「建议将这个值定义为常量，因为它在多处使用且将来可能需要修改」

3. **提供示例**：
   - ❌ 「这里应该使用更好的错误处理」
   - ✅ 「建议使用 try-catch 块处理这个异步操作，例如:
     ```typescript
     try {
       const result = await api.fetchData();
       // 处理结果
     } catch (error) {
       // 错误处理
     }
     ```

4. **关注代码，不针对个人**：
   - ❌ 「你没有正确实现这个功能」
   - ✅ 「这个功能可能需要考虑 X 情况，建议添加相应的处理逻辑」

5. **平衡正面和负面反馈**：
   - 指出问题的同时，也肯定好的实现
   - 「我喜欢你对组件的划分，非常清晰。这里有一点小建议...」

6. **区分必须修改和建议**：
   - 「【必须】这里存在安全漏洞，需要添加输入验证」
   - 「【建议】考虑使用更具描述性的方法名称」

## 示例与最佳实践

### 良好的 PR 描述示例

```
标题：实现用户登录功能

## 变更内容

- 添加用户登录页面组件
- 实现登录表单与验证
- 对接后端登录 API
- 实现登录状态管理

## 测试内容

- 成功登录场景
- 密码错误场景
- 输入格式验证

## 注意事项

- 登录状态保存在 localStorage，未来可能需要考虑安全性增强

## 屏幕截图

[登录页面截图链接]
```

### 有效的代码审查评论示例

#### 提出问题并给出解决方案

这个组件中的状态逻辑比较复杂，建议将它提取到一个独立的 composable 函数中，例如:

```typescript
// useLoginForm.ts
export function useLoginForm() {
  const username = ref('');
  const password = ref('');
  const isLoading = ref(false);

  async function submit() {
    // 逻辑...
  }

  return { username, password, isLoading, submit };
}
```

这样可以提高组件的可读性，并且使逻辑更容易测试。

#### 指出性能问题

这里每次渲染都在重新计算过滤结果，可能会导致性能问题。建议使用 computed 属性:

```typescript
const filteredItems = computed(() => {
  return items.value.filter(item => item.price > minPrice.value);
});
```

#### 提示安全问题

这个 API 调用没有对用户输入进行验证，可能存在 XSS 风险。建议在发送请求前添加验证或清理:

```typescript
// 添加输入验证
if (!isValidUsername(username.value)) {
  return { error: '用户名格式不正确' };
}
```
